<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  // ==== SUPABASE ====
  const SUPABASE_URL = 'https://dbgxlisqdtflxhqyrctz.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRiZ3hsaXNxZHRmbHhocXlyY3R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3MzU4MDEsImV4cCI6MjA3MDMxMTgwMX0.3k1i4UMtgaqvs6B6QwefOEonsroQXv9m933_Dj3rkBs';
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ==== UTIL/UI ====
  const $ = id => document.getElementById(id);
  const showLoading = on => $('loading')?.classList?.toggle('show', !!on);
  const closeAll = () => {
    ['loginOv','browseOv','adminOv','settingsOv','accountOv'].forEach(id => $(id)?.classList.remove('show'));
  };
  const toast = (msg, ok=false)=> alert((ok?'✅ ':'⚠️ ') + msg);
  const formatDate = iso => { try{ return new Date(iso).toLocaleDateString('id-ID'); }catch{return iso} };

  const gudangList = ['HBB','BTA','B99','SEWU','DOMSEK','SEKUTER','GC','MARINA','BIROTIKA','BTC','POS','FEDEX','GLB','APLOG','DBM','IBL','AEI','RORO','PUNGGUR','KABIL','BANDARA','WH','NONGSA','BLP'];

  // state
  let currentUser = null, isAdmin = false, allowedGudang = [];
  let historyCache = [], profilesMap = {};
  let sortKey='tanggal', sortDir='desc', page=1, pageSize=25;

  // ==== AUTH HELPERS ====
  async function ensureProfile(user){
    // Buat profile jika belum ada; role default "user"
    const { data, error } = await supabase
      .from('profiles')
      .select('id, role, username, email')
      .eq('id', user.id)
      .maybeSingle();
    if (error && error.code !== 'PGRST116') throw error; // error lain selain "no rows"
    if (!data){
      const username = user.user_metadata?.full_name || user.email || user.id;
      const { error: insErr } = await supabase.from('profiles')
        .insert({ id: user.id, email: user.email, username, role: 'user' });
      if (insErr && insErr.code !== '23505') throw insErr; // ignore conflict
    }
  }

  async function loadAccess(){
    const { data } = await supabase.auth.getUser();
    const me = data?.user; if (!me){ isAdmin=false; allowedGudang=[]; return; }
    // pastikan profile ada
    await ensureProfile(me);

    // ambil role
    let role = 'user', username = me.email;
    try{
      const { data: prof } = await supabase
        .from('profiles')
        .select('role, username, email')
        .eq('id', me.id)
        .single();
      role = prof?.role || 'user';
      username = prof?.username || prof?.email || me.email;
    }catch{ /* biarin default */ }

    isAdmin = (role === 'admin');
    $('accountEmail').textContent = `Masuk sebagai: ${username}`;

    // akses multi-gudang
    if (isAdmin){
      allowedGudang = [...gudangList];
    } else {
      const { data: rows } = await supabase
        .from('roles_by_gudang')
        .select('gudang')
        .eq('user_id', me.id);
      allowedGudang = (rows||[]).map(r=>r.gudang);
    }

    // toggle UI admin
    $('btnAdmin').style.display = isAdmin ? '' : 'none';
    $('btnSettings').style.display = isAdmin ? '' : 'none';
    $('btnDeleteSelected').style.display = isAdmin ? '' : 'none';
    $('thSel').style.display = isAdmin ? '' : 'none';
    $('brSelTh').style.display = isAdmin ? '' : 'none';
  }

  function fillGudangSelect(){
    const sel = $('gudang');
    const list = isAdmin ? gudangList : gudangList.filter(g => allowedGudang.includes(g));
    sel.innerHTML = '<option value="">-- Pilih --</option>' + list.map(g=>`<option>${g}</option>`).join('');
    if(!isAdmin && list.length===1){ sel.value=list[0]; sel.disabled=true; } else { sel.disabled=false; }
  }

  // ==== HISTORY ====
  async function buildProfilesMap(fromRows){
    const ids = Array.from(new Set((fromRows||[]).map(r => r.created_by).filter(Boolean)));
    if (!ids.length){ profilesMap={}; return; }
    const { data } = await supabase.from('profiles').select('id, username, email').in('id', ids);
    profilesMap = {}; (data||[]).forEach(p=> profilesMap[p.id] = p.username || p.email || p.id);
  }

  async function fetchHistory(){
    const { data, error } = await supabase
      .from('penunjukan_history')
      .select('*')
      .order('id',{ascending:false})
      .limit(1000);
    if (error) throw error;
    historyCache = data||[];
    await buildProfilesMap(historyCache);
  }

  function applyFilterSortPaginate(){
    const q = $('searchBox')?.value?.trim().toLowerCase() || '';
    let rows = historyCache.slice();
    if (q){
      rows = rows.filter(r=>{
        const pet = profilesMap[r.created_by] || '';
        return [r.nomor,r.jenis,r.gudang,r.pemeriksa,pet].some(x=> String(x||'').toLowerCase().includes(q));
      });
    }
    rows.sort((a,b)=>{
      const A = (sortKey==='petugas') ? (profilesMap[a.created_by]||'') :
                (sortKey==='tanggal') ? (a.tanggal||'') :
                (a[sortKey]||'');
      const B = (sortKey==='petugas') ? (profilesMap[b.created_by]||'') :
                (sortKey==='tanggal') ? (b.tanggal||'') :
                (b[sortKey]||'');
      return (A>B?1:A<B?-1:0) * (sortDir==='asc'?1:-1);
    });
    pageSize = parseInt($('pageSize')?.value||'25',10);
    const total = rows.length, maxPage = Math.max(1, Math.ceil(total/pageSize));
    if (page>maxPage) page=maxPage;
    const slice = rows.slice((page-1)*pageSize, (page-1)*pageSize+pageSize);

    const html = slice.map(r=>`
      <tr data-id="${r.id}">
        ${isAdmin?`<td><input type="checkbox" class="chkRow"></td>`:''}
        <td>${formatDate(r.tanggal)}</td>
        <td class="nowrap">${r.nomor}</td>
        <td>${r.jenis}</td>
        <td><span class="tag">${r.gudang}</span></td>
        <td>${r.pemeriksa}</td>
        <td>${profilesMap[r.created_by]||''}</td>
      </tr>`).join('');
    const cols = isAdmin?7:6;
    document.querySelector('#riwayat tbody').innerHTML = html || `<tr><td colspan="${cols}" class="muted">Belum ada data</td></tr>`;
    $('pageInfo').textContent = `Menampilkan ${slice.length} / ${total} (hal. ${page}/${maxPage})`;
  }

  async function getPoolRemainingCount(g){
    if(!g) return 0;
    const { data: pool } = await supabase.from('pools').select('remaining').eq('gudang', g).maybeSingle();
    if (pool && Array.isArray(pool.remaining) && pool.remaining.length) return pool.remaining.length;
    const { data: list } = await supabase.from('pemeriksa').select('id').eq('gudang', g);
    return (list||[]).length;
  }
  async function updateTotal(){ $('totalTersisa').textContent = await getPoolRemainingCount($('gudang').value); }

  // ==== OPERASI INTI ====
  async function pickNama(gudang){
    const { data, error } = await supabase.rpc('pick_pemeriksa',{ gudang_in:gudang });
    if (error) throw error;
    return data;
  }
  async function addHistory({ nomor, jenis, gudang, pemeriksa }){
    const { error } = await supabase.from('penunjukan_history').insert({ nomor, jenis, gudang, pemeriksa });
    if (error) throw error;
  }

  // ==== ADMIN ====
  async function renderAdminTable(){
    const { data } = await supabase.from('pemeriksa').select('*').order('nama');
    const rows = data||[];
    $('adminBody').innerHTML = rows.map(p=>`
      <tr data-id="${p.id}">
        <td>${p.nama}</td>
        <td><select class="selGudang" style="width:100%">${['',...gudangList].map(g=>`<option value="${g}" ${g===p.gudang?'selected':''}>${g||'-- Pilih --'}</option>`).join('')}</select></td>
        <td><label style="display:flex;gap:.4rem;align-items:center"><input type="checkbox" class="chkDel"> Hapus</label></td>
      </tr>`).join('');
    $('adminTotal').textContent = `Total: ${rows.length} pemeriksa`;
    $('newGudang').innerHTML = '<option value="">-- Pilih --</option>' + gudangList.map(g=>`<option>${g}</option>`).join('');
  }
  async function addPemeriksa(nama,gudang){
    const { error } = await supabase.from('pemeriksa').insert({ nama, gudang });
    if (error) throw error;
  }
  async function savePemeriksaChanges(){
    const trs = [...document.querySelectorAll('#adminBody tr')];
    for (const tr of trs){
      const id = +tr.dataset.id;
      const gd = tr.querySelector('.selGudang').value || null;
      const { error } = await supabase.from('pemeriksa').update({ gudang: gd }).eq('id', id);
      if (error) throw error;
    }
  }
  async function deleteCheckedPemeriksa(){
    const ids = [...document.querySelectorAll('#adminBody tr')].filter(tr=>tr.querySelector('.chkDel')?.checked).map(tr=>+tr.dataset.id);
    if (!ids.length) return;
    const { error } = await supabase.from('pemeriksa').delete().in('id', ids);
    if (error) throw error;
  }

  // ==== REALTIME ====
  function setupRealtime(){
    supabase.channel('rt-penunjukan')
      .on('postgres_changes',{ event:'*', schema:'public', table:'penunjukan_history' }, async (payload)=>{
        try{
          if(payload.eventType==='INSERT'){
            historyCache.unshift(payload.new);
            const uid = payload.new?.created_by;
            if(uid && !profilesMap[uid]){
              const { data } = await supabase.from('profiles').select('id, username, email').eq('id', uid).single();
              if(data) profilesMap[uid] = data.username || data.email || uid;
            }
          } else if (payload.eventType==='DELETE'){
            historyCache = historyCache.filter(r=>r.id!==payload.old.id);
          } else if (payload.eventType==='UPDATE'){
            const i = historyCache.findIndex(r=>r.id===payload.new.id);
            if(i>-1) historyCache[i]=payload.new;
          }
          applyFilterSortPaginate();
          updateTotal();
        }catch(e){ console.error(e); }
      })
      .subscribe();
  }

  // ==== SETTINGS (roles multi-gudang) ====
  async function loadUsersSettings(){
    const { data: users } = await supabase.from('profiles').select('id, username, role, email').order('username');
    const { data: rbg } = await supabase.from('roles_by_gudang').select('user_id, gudang');
    const map = {};
    (rbg||[]).forEach(r => { (map[r.user_id] ||= []).push(r.gudang); });
    const tb = document.querySelector('#userTable tbody');
    tb.innerHTML = (users||[]).map(u=>`
      <tr data-id="${u.id}">
        <td>${u.username||u.email||'(tanpa nama)'}</td>
        <td>${u.role||'user'}</td>
        <td>${(map[u.id]||[]).join(', ')}</td>
        <td>
          <button class="btn secondary small btnEditUser" data-id="${u.id}">Edit</button>
          <button class="btn danger small btnClearRole" data-id="${u.id}">Kosongkan</button>
        </td>
      </tr>`).join('');
    // simpan ke window utk handler click
    window._usersCache = users||[];
    window._rolesMap = map;
  }

  // ==== INIT ====
  document.addEventListener('DOMContentLoaded', async ()=>{
    // buka login sampai ada sesi
    $('loginOv').classList.add('show');

    // auth listener
    supabase.auth.onAuthStateChange(async (_evt, session)=>{
      currentUser = session?.user || null;
      if (!currentUser){ $('loginOv').classList.add('show'); return; }
      closeAll(); // tutup semua overlay
      showLoading(true);
      try{
        await loadAccess();
        fillGudangSelect();
        await fetchHistory();
        applyFilterSortPaginate();
        setupRealtime();
        await updateTotal();
      } finally { showLoading(false); }
    });

    // cek sesi awal (biar nggak nunggu event)
    const { data: { session } } = await supabase.auth.getSession();
    if (session?.user){
      currentUser = session.user;
      $('loginOv').classList.remove('show');
      showLoading(true);
      try{
        await loadAccess();
        fillGudangSelect();
        await fetchHistory();
        applyFilterSortPaginate();
        setupRealtime();
        await updateTotal();
      } finally { showLoading(false); }
    }

    // ====== LOGIN / LOGOUT / AKUN ======
    $('loginBtn').onclick = async ()=>{
      $('loginErr').style.display='none';
      const email = $('loginEmail').value.trim();
      const pass  = $('loginPass').value;
      if(!email || !pass){ $('loginErr').textContent='Email & password wajib diisi'; $('loginErr').style.display='inline-block'; return; }
      showLoading(true);
      try{
        const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
        if (error) throw error;
        await ensureProfile(data.user);
        // onAuthStateChange akan ngurus UI
      }catch(e){
        $('loginErr').textContent = e?.message || 'Password salah';
        $('loginErr').style.display='inline-block';
        $('loginPass').value=''; $('loginPass').focus(); // user tetap, password kosong
      }finally{ showLoading(false); }
    };
    $('loginPass').addEventListener('keydown',(e)=>{ if(e.key==='Enter') $('loginBtn').click(); });
    $('closeLogin').onclick = ()=>{}; // biar nggak bisa nutup sebelum login

    $('btnLogout').onclick = async ()=>{
      if(!confirm('Yakin logout?')) return;
      await supabase.auth.signOut();
      $('loginEmail').value=''; $('loginPass').value=''; $('loginErr').style.display='none';
      closeAll(); $('loginOv').classList.add('show');
    };

    $('btnAccount').onclick = async ()=>{
      const { data } = await supabase.auth.getUser(); if(!data?.user){ $('loginOv').classList.add('show'); return; }
      closeAll(); $('accountOv').classList.add('show');
    };
    $('accountClose').onclick = ()=> $('accountOv').classList.remove('show');
    $('btnChangePass').onclick = async ()=>{
      const p1 = $('newPass').value, p2 = $('newPass2').value;
      const msg = $('accMsg'); msg.style.display='none';
      if(!p1 || p1.length<6) return toast('Password minimal 6 karakter');
      if(p1!==p2) return toast('Konfirmasi password tidak sama');
      showLoading(true);
      try{
        const { error } = await supabase.auth.updateUser({ password: p1 });
        if (error) throw error;
        $('newPass').value=''; $('newPass2').value='';
        msg.textContent='Password berhasil diubah'; msg.style.display='inline-block'; msg.style.color='#065f46';
        toast('Password berhasil diubah', true);
      }catch(e){ toast(e.message||'Gagal ubah password'); }
      finally{ showLoading(false); }
    };

    // ====== NAV/MODALS ======
    $('btnBrowse').onclick = ()=>{ closeAll(); $('browseOv').classList.add('show'); };
    $('browseClose').onclick = ()=> $('browseOv').classList.remove('show');
    $('btnAdmin').onclick = async ()=>{
      const { data } = await supabase.auth.getUser(); if(!data?.user) return $('loginOv').classList.add('show');
      if(!isAdmin) return toast('Hanya admin');
      showLoading(true); closeAll();
      try{ await renderAdminTable(); $('adminOv').classList.add('show'); } finally{ showLoading(false); }
    };
    $('adminClose').onclick = ()=> $('adminOv').classList.remove('show');
    $('btnSettings').onclick = async ()=>{
      const { data } = await supabase.auth.getUser(); if(!data?.user) return $('loginOv').classList.add('show');
      if(!isAdmin) return toast('Hanya admin');
      $('userRoles').innerHTML = gudangList.map(g=>`<option value="${g}">${g}</option>`).join('');
      showLoading(true); closeAll();
      try{ await loadUsersSettings(); $('settingsOv').classList.add('show'); } finally{ showLoading(false); }
    };
    $('settingsClose').onclick = ()=> $('settingsOv').classList.remove('show');

    // klik area gelap menutup modal
    ['browseOv','adminOv','settingsOv','accountOv'].forEach(id=>{
      $(id).addEventListener('click', e=>{ if(e.target.id===id) $(id).classList.remove('show'); });
    });

    // ====== INPUT & TUNJUK ======
    $('gudang').addEventListener('change', updateTotal);
    $('btnTunjuk').onclick = async ()=>{
      const nomor = $('nomor').value.trim();
      const jenis = $('jenis').value;
      const gud   = $('gudang').value;
      if(!/^\d+$/.test(nomor)) return toast('Nomor hanya angka');
      if(!jenis || !gud) return toast('Lengkapi form');
      showLoading(true);
      try{
        const { data: exist } = await supabase.from('penunjukan_history').select('id').eq('nomor', nomor).eq('jenis', jenis).limit(1);
        if (exist && exist.length) { toast('Penunjukan untuk nomor & jenis ini sudah ada'); return; }
        const nama = await pickNama(gud);
        await addHistory({ nomor, jenis, gudang: gud, pemeriksa: nama });
        $('nomor').value=''; $('jenis').value='';
        toast(`Berhasil menugaskan: ${nama}`, true);
        await fetchHistory(); applyFilterSortPaginate(); updateTotal();
      }catch(e){ toast(e.message||'Gagal menugaskan'); }
      finally{ showLoading(false); }
    };

    // ====== R I W A Y A T : search/sort/paging ======
    $('searchBox').addEventListener('input', ()=>{ page=1; applyFilterSortPaginate(); });
    $('pageSize').addEventListener('change', ()=>{ page=1; applyFilterSortPaginate(); });
    $('prevPage').onclick = ()=>{ if(page>1){ page--; applyFilterSortPaginate(); } };
    $('nextPage').onclick = ()=>{ page++; applyFilterSortPaginate(); };
    document.querySelectorAll('th.sortable').forEach(th=>{
      th.style.cursor='pointer';
      th.addEventListener('click',()=>{
        const key = th.dataset.key;
        if (sortKey===key){ sortDir = (sortDir==='asc'?'desc':'asc'); } else { sortKey=key; sortDir='asc'; }
        applyFilterSortPaginate();
      });
    });

    // ====== BROWSE ======
    async function renderBrowse(nomor){
      const { data } = await supabase.from('penunjukan_history').select('*').order('id',{ascending:false}).limit(500);
      const rows = (nomor ? (data||[]).filter(r=>String(r.nomor)===String(nomor)) : (data||[]));
      const ids = Array.from(new Set(rows.map(r=>r.created_by).filter(Boolean)));
      let map={}; if(ids.length){ const { data:p } = await supabase.from('profiles').select('id, username, email').in('id', ids); (p||[]).forEach(x=> map[x.id]=x.username||x.email||x.id); }
      const body = document.querySelector('#browseTable tbody');
      body.innerHTML = rows.map(r=>`
        <tr data-id="${r.id}">
          ${isAdmin?`<td><input type="checkbox" class="chkBr"></td>`:''}
          <td>${formatDate(r.tanggal)}</td><td>${r.nomor}</td><td>${r.jenis}</td><td>${r.gudang}</td><td>${r.pemeriksa}</td><td>${map[r.created_by]||''}</td>
        </tr>`).join('') || `<tr><td colspan="${isAdmin?7:6}" class="muted">Tidak ada data</td></tr>`;
      $('btnBrowseDel').style.display = isAdmin ? '' : 'none';
    }
    $('btnBrowseGo').onclick = ()=> renderBrowse($('browseNomor').value.trim());
    $('btnBrowseDel').onclick = async ()=>{
      const ids = [...document.querySelectorAll('#browseTable tbody tr')].filter(tr=>tr.querySelector('.chkBr')?.checked).map(tr=>+tr.dataset.id);
      if(!ids.length) return toast('Pilih baris yang akan dihapus');
      if(!confirm(`Hapus ${ids.length} riwayat terpilih?`)) return;
      showLoading(true);
      try{
        const { error } = await supabase.from('penunjukan_history').delete().in('id', ids);
        if (error) throw error;
        await fetchHistory(); applyFilterSortPaginate(); renderBrowse($('browseNomor').value.trim());
        toast('Riwayat terpilih dihapus', true);
      }catch(e){ toast(e.message||'Gagal hapus riwayat'); }
      finally{ showLoading(false); }
    };

    // ====== ADMIN ACTIONS ======
    $('btnAdd').onclick = async ()=>{
      const nm = $('newNama').value.trim(); const gd = $('newGudang').value;
      if(!nm || !gd) return toast('Isi nama & gudang');
      showLoading(true);
      try{ await addPemeriksa(nm, gd); $('newNama').value=''; $('newGudang').value=''; await renderAdminTable(); toast('Ditambahkan', true); }
      catch(e){ toast(e.message||'Gagal tambah pemeriksa'); }
      finally{ showLoading(false); }
    };
    $('btnSaveChanges').onclick = async ()=>{
      showLoading(true);
      try{ await savePemeriksaChanges(); toast('Perubahan disimpan', true); }
      catch(e){ toast(e.message||'Gagal simpan perubahan'); }
      finally{ showLoading(false); }
    };
    $('btnDelChecked').onclick = async ()=>{
      if(!confirm('Hapus baris yang dicentang?')) return;
      showLoading(true);
      try{ await deleteCheckedPemeriksa(); await renderAdminTable(); toast('Baris dihapus', true); }
      catch(e){ toast(e.message||'Gagal hapus'); }
      finally{ showLoading(false); }
    };

    // ====== SETTINGS (roles multi-gudang) ======
    $('userTable').addEventListener('click', async (e)=>{
      const id = e.target.dataset.id; if(!id) return;
      if (e.target.classList.contains('btnEditUser')){
        const { data: users } = await supabase.from('profiles').select('id, username, email').eq('id', id).limit(1);
        $('userName').value = users?.[0]?.username || users?.[0]?.email || '';
        const { data: rbg } = await supabase.from('roles_by_gudang').select('gudang').eq('user_id', id);
        [...$('userRoles').options].forEach(opt => opt.selected = (rbg||[]).some(r=>r.gudang===opt.value));
        window._editingUserId = id;
      }
      if (e.target.classList.contains('btnClearRole')){
        if(!confirm('Kosongkan semua akses gudang user ini?')) return;
        await supabase.from('roles_by_gudang').delete().eq('user_id', id);
        await loadUsersSettings();
      }
    });
    $('btnSaveUser').onclick = async ()=>{
      const id = window._editingUserId;
      if(!id) return toast('Klik Edit pada salah satu user');
      const selected = [...$('userRoles').selectedOptions].map(o=>o.value);
      showLoading(true);
      try{
        await supabase.from('roles_by_gudang').delete().eq('user_id', id);
        if(selected.length){
          await supabase.from('roles_by_gudang').insert(selected.map(g=>({ user_id:id, gudang:g })));
        }
        await loadUsersSettings();
        toast('Akses gudang disimpan', true);
      }catch(e){ toast(e.message||'Gagal simpan'); }
      finally{ showLoading(false); }
    };
    $('btnCancelUser').onclick = ()=>{ window._editingUserId=null; $('userName').value=''; [...$('userRoles').options].forEach(o=>o.selected=false); };

  });
</script>

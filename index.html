<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Perekaman Kesiapan Barang — Supabase</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --gradient-bg: linear-gradient(135deg, #002244 0%, #003366 100%);
      --panel-bg: #f7f8fa;
      --text-dark: #333;
      --text-muted: #666;
      --accent-blue: #002d62;
      --accent-gold: #d4af37;
      --border: #dce0e6;
      --radius: 10px;
      --shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: var(--gradient-bg); color: var(--text-dark); min-height: 100vh; display: flex; flex-direction: column; }
    body.blurred > header, body.blurred > main { filter: blur(4px); header { position: sticky;  top: 0;  z-index: 1500; } .overlay, .login-overlay { z-index: 1000; } }
    header { background: rgba(0,45,98,0.9); color: #fff; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); }
    .title-wrapper h1 { font-size: 1.6rem; font-weight: 600; }
    .title-wrapper h2 { font-size: .95rem; color: var(--accent-gold); margin-top: .25rem; font-weight: 500; }
    .header-buttons button { margin-left: .5rem; background: transparent; color: #fff; border: 2px solid #fff; padding: .5rem 1rem; border-radius: var(--radius); cursor: pointer; transition: background .2s; }
    .header-buttons button:hover { background: rgba(255,255,255,0.2); }
    main { flex: 1; max-width: 1100px; margin: 2rem auto; padding: 0 1rem; display: grid; grid-template-columns: repeat(auto-fit,minmax(340px,1fr)); gap: 1.5rem; }
    .panel { background: var(--panel-bg); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.5rem; box-shadow: var(--shadow); }
    .panel h3 { margin-bottom: 1rem; color: var(--accent-blue); font-size: 1.05rem; font-weight: 700; letter-spacing: .3px; text-transform: uppercase; }
    label { display: block; margin-top: 1rem; font-size: .9rem; color: var(--text-muted); font-weight: 500; }
    input, select { width: 100%; padding: .6rem; margin-top: .35rem; border: 1px solid var(--border); border-radius: var(--radius); font-size: 1rem; background: #fff; transition: border-color .2s, box-shadow .2s; }
    input:focus, select:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 6px rgba(0,45,98,0.3); }
    .btn { display: inline-block; padding: .75rem 1.2rem; font-weight: 700; font-size: .95rem; border-radius: 999px; border: none; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: transform .15s, box-shadow .15s; margin-top: .9rem; }
    .btn.primary { background: var(--accent-gold); color: var(--accent-blue); }
    .btn.primary:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); background: var(--accent-blue); color: #fff; }
    .btn.secondary { background: transparent; color: var(--accent-blue); border: 2px solid var(--accent-blue); }
    .btn.secondary:hover { background: var(--accent-blue); color: #fff; }
    .btn.danger { background: #d9534f; color: #fff; }
    .btn.danger:hover { background: #c12e2a; }
    p.info { margin-top: .8rem; font-size: .95rem; color: var(--accent-blue); font-weight: 600; }
    .table-wrapper { max-height: 60vh; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius); margin-top: .6rem; }
    table { width: 100%; border-collapse: collapse; font-size: .9rem; }
    th, td { padding: .6rem; border-bottom: 1px solid var(--border); text-align: left; }
    th { color: var(--accent-gold); position: sticky; top: 0; background: var(--panel-bg); z-index: 1; }
    tr:nth-child(even) { background: rgba(0,45,98,0.05); }
    .overlay, .login-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: none; align-items: center; justify-content: center; padding: 1rem; z-index: 1000; }
    .overlay.show, .login-overlay.show { display: flex; }
    .modal, .login-modal { background: var(--panel-bg); border-radius: var(--radius); padding: 1.2rem 1.4rem; width: 100%; max-width: 760px; box-shadow: var(--shadow); position: relative; max-height: 85vh; overflow-y: auto; transform: translateY(-18px); opacity: 0; transition: transform .2s, opacity .2s; }
    .overlay.show .modal, .login-overlay.show .login-modal { transform: translateY(0); opacity: 1; }
    .close-btn { position: absolute; top: .9rem; right: .9rem; width: 28px; height: 28px; background: var(--accent-gold); color: var(--accent-blue); border-radius: 50%; text-align: center; line-height: 28px; cursor: pointer; transition: background .2s; font-weight: 800; }
    .close-btn:hover { background: var(--accent-blue); color: #fff; }
    small.hint { color: var(--text-muted); display: inline-block; margin-top: .25rem; }
  </style>
</head>
<body>
  <header>
    <div class="title-wrapper">
      <h1>Perekaman Kesiapan Barang</h1>
      <h2>KPU BC TIPE B BATAM</h2>
    </div>
    <div class="header-buttons">
      <button id="btnBrowseHeader">Browse</button>
      <button id="btnSettingsHeader" style="display:none;">Settings</button>
      <button id="btnAdminHeader" style="display:none;">Admin</button>
      <button id="btnLogout" class="btn secondary">Logout</button>
    </div>
  </header>

  <main>
    <div class="panel">
      <h3>Input Penunjukan</h3>
      <label for="nomor">Nomor Pendaftaran</label>
      <input id="nomor" placeholder="10001234" />
      <label for="jenis">Jenis Dokumen</label>
      <select id="jenis">
        <option value="">-- Pilih --</option>
        <option>01 LDP IN</option><option>01 LDP OUT</option><option>01 TLDPP</option>
        <option>02 OUT</option><option>02 IN</option><option>03 IN</option>
      </select>
      <label for="gudang">Gudang</label>
      <select id="gudang"><option value="">-- Pilih --</option></select>
      <button id="btnTunjuk" class="btn primary">Tunjuk Pemeriksa</button>
      <p class="info">Total Tersisa: <span id="totalTersisa">0</span></p>
    </div>

    <div class="panel">
      <h3>Riwayat Penunjukan</h3>
      <div class="table-wrapper">
        <table id="riwayat">
          <thead>
            <tr>
              <th>No</th><th>Nomor</th><th>Jenis</th><th>Gudang</th>
              <th>Tanggal</th><th>Pemeriksa</th><th>Petugas</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Browse Modal -->
  <div class="overlay" id="browseOverlay">
    <div class="modal">
      <span class="close-btn" id="browseClose">&times;</span>
      <h3>Browse Penunjukan</h3>
      <label>Nomor Pendaftaran</label>
      <input id="browseNomor" placeholder="(kosong = semua)" />
      <button id="btnBrowseModal" class="btn primary">Tampilkan</button>
      <div class="table-wrapper" style="margin-top:1rem;">
        <table id="browseResults">
          <thead>
            <tr>
              <th>No</th><th>Nomor</th><th>Jenis</th><th>Gudang</th>
              <th>Tanggal</th><th>Pemeriksa</th><th>Petugas</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-modal">
      <span class="close-btn" id="loginClose">&times;</span>
      <h3>Login</h3>
      <label>Email</label>
      <input id="loginUser" type="email" placeholder="nama@contoh.com" />
      <label>Password</label>
      <input id="loginPass" type="password" />
      <button id="loginBtn" class="btn primary">Masuk</button>
      <small class="hint">Akun dikelola oleh admin melalui Supabase Dashboard.</small>
    </div>
  </div>

  <!-- Admin Modal -->
  <div class="overlay" id="adminOverlay">
    <div class="modal">
      <span class="close-btn" id="btnCloseAdmin">&times;</span>
      <h3>Menu Admin</h3>
      <p class="info">Total Pemeriksa: <strong><span id="adminTotal"></span></strong></p>
      <label>Preview Pemeriksa Berikutnya</label>
      <select id="adminGudangPreview"><option value="">-- Pilih --</option></select>
      <p class="info">Selanjutnya: <strong><span id="adminNext">-</span></strong></p>

      <table id="adminTable" style="margin-top:1rem;">
        <thead>
          <tr><th>Nama</th><th>Gudang</th><th>Aksi</th></tr>
        </thead>
        <tbody id="adminBody"></tbody>
      </table>

      <h4 style="margin-top:1rem">Tambah Pemeriksa</h4>
      <input id="newNama" placeholder="Nama baru" />
      <select id="newGudang"><option value="">-- Pilih --</option></select>
      <div>
        <button id="btnAdd" class="btn primary">Tambah</button>
        <button id="btnUpd" class="btn secondary">Update</button>
        <button id="btnDelSel" class="btn danger">Hapus yang Dipilih</button>
      </div>
      <div style="margin-top:.6rem;">
        <button id="btnClearHist" class="btn danger">Hapus Semua Riwayat</button>
        <button id="btnResetPool" class="btn secondary">Reset Pool & Preview</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="overlay" id="settingsOverlay">
    <div class="modal">
      <span class="close-btn" id="settingsClose">&times;</span>
      <h3>Setting User (Admin)</h3>
      <p style="margin:.3rem 0 .8rem;color:#666">
        Tambah/hapus user & ganti password tetap lewat <b>Supabase → Auth → Users</b> (aman).
        Dari sini admin bisa atur <b>akses gudang</b> tiap user.
      </p>

      <table id="userTable" style="width:100%;margin-bottom:1rem;">
        <thead><tr><th>Email</th><th>Role</th><th>Gudang</th><th>Aksi</th></tr></thead>
        <tbody></tbody>
      </table>

      <h4>Ubah Akses Gudang</h4>
      <label>Email</label>
      <input id="userName" placeholder="Pilih user lewat tombol Edit di tabel" disabled>
      <label>Allowed Gudang (Ctrl/⌘ + klik bisa multi)</label>
      <select id="userRoles" multiple size="6" style="width:100%;margin-top:.3rem;"></select>

      <div style="margin-top:.6rem;">
        <button id="btnSaveUser" class="btn primary">Simpan</button>
        <button id="btnCancelUser" class="btn secondary">Batal</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // === KUNCI PROYEK KAMU ===
    const SUPABASE_URL = 'https://dbgxlisqdtflxhqyrctz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRiZ3hsaXNxZHRmbHhocXlyY3R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3MzU4MDEsImV4cCI6MjA3MDMxMTgwMX0.3k1i4UMtgaqvs6B6QwefOEonsroQXv9m933_Dj3rkBs';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // === KONSTAN ===
    const gudangList = [
      'HBB','BTA','B99','SEWU','DOMSEK','SEKUTER','GC','MARINA','BIROTIKA','BTC','POS','FEDEX','GLB','APLOG','DBM','IBL','AEI','RORO','PUNGGUR','KABIL','BANDARA','WH','NONGSA','BLP'
    ];

    // === ELEMEN ===
    const el = (id)=>document.getElementById(id);
    const tblBody = document.querySelector('#riwayat tbody');

    // === AUTH ===
    async function signIn(email, password){
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) throw error; return data.user;
    }
    async function signOut(){ await supabase.auth.signOut(); }
    async function me(){ const { data } = await supabase.auth.getUser(); return data.user; }

    async function getAccess(){
      const user = await me(); if(!user) return { admin:false, allowed:[] };
      const { data: prof } = await supabase.from('profiles').select('role').eq('id', user.id).single();
      const admin = prof?.role === 'admin';
      if (admin) return { admin:true, allowed: null };
      const { data: rows } = await supabase.from('roles_by_gudang').select('gudang').eq('user_id', user.id);
      return { admin:false, allowed: rows?.map(r=>r.gudang)||[] };
    }

    // === DATA HELPERS ===
    async function listHistory({ nomor }={}){
      const user = await me(); if(!user) return [];
      let q = supabase.from('penunjukan_history').select('*').order('id', { ascending:false });
      if (nomor) q = q.eq('nomor', nomor);
      const { data, error } = await q; if (error) throw error; return data || [];
    }

    async function pickNama(gudang){
      const { data, error } = await supabase.rpc('pick_pemeriksa', { gudang_in: gudang });
      if (error) throw error; return data;
    }
    async function addHistory({ nomor, jenis, gudang, pemeriksa }){
      const { error } = await supabase.from('penunjukan_history').insert({ nomor, jenis, gudang, pemeriksa });
      if (error) throw error;
    }

    async function listPemeriksa(g){
      let q = supabase.from('pemeriksa').select('*').order('nama');
      if (g) q = q.eq('gudang', g);
      const { data, error } = await q; if (error) throw error; return data || [];
    }
    async function addPemeriksa(nama, gudang){
      const { error } = await supabase.from('pemeriksa').insert({ nama, gudang });
      if (error) throw error;
    }
    async function updPemeriksa(id, gudang){
      const { error } = await supabase.from('pemeriksa').update({ gudang }).eq('id', id);
      if (error) throw error;
    }
    async function delPemeriksa(id){
      const { error } = await supabase.from('pemeriksa').delete().eq('id', id);
      if (error) throw error;
    }
    async function setPreview(gudang, nama){
      const { error } = await supabase.from('preview_pick').upsert({ gudang, nama });
      if (error) throw error;
    }
    async function getPoolRemainingCount(g){
      const { data: pool } = await supabase.from('pools').select('remaining').eq('gudang', g).single();
      if (pool && Array.isArray(pool.remaining) && pool.remaining.length) return pool.remaining.length;
      const list = await listPemeriksa(g); return list.length;
    }

    // === UI LOGIC ===
    async function applyRoleAndGudang(){
      const acc = await getAccess();
      const sel = el('gudang');
      const list = acc.admin ? gudangList : gudangList.filter(g => acc.allowed.includes(g));
      sel.innerHTML = '<option value="">-- Pilih --</option>' + list.map(g=>`<option>${g}</option>`).join('');
      if(!acc.admin && list.length===1){ sel.value = list[0]; sel.disabled = true; await updateTotal(); }
      // tampilkan tombol sesuai role
      el('btnAdminHeader').style.display    = acc.admin ? '' : 'none';
      el('btnSettingsHeader').style.display = acc.admin ? '' : 'none';
      // dropdown yang lain
      el('newGudang').innerHTML = '<option value="">-- Pilih --</option>' + gudangList.map(g=>`<option>${g}</option>`).join('');
      el('adminGudangPreview').innerHTML = '<option value="">-- Pilih --</option>' + gudangList.map(g=>`<option>${g}</option>`).join('');
    }

    async function renderRiwayat(){
      const rows = await listHistory();
      tblBody.innerHTML = rows.length ? rows.map((r,i)=>`
        <tr>
          <td>${i+1}</td>
          <td>${r.nomor}</td>
          <td>${r.jenis}</td>
          <td>${r.gudang}</td>
          <td>${new Date(r.tanggal).toLocaleDateString('id-ID')}</td>
          <td>${r.pemeriksa}</td>
          <td>${(r.created_by||'').toString().slice(0,8)}</td>
        </tr>`).join('') : '<tr><td colspan="7">Belum ada penunjukan</td></tr>';
    }

    async function updateTotal(){
      const g = el('gudang').value; if(!g){ el('totalTersisa').innerText = '0'; return; }
      const n = await getPoolRemainingCount(g); el('totalTersisa').innerText = n;
    }

    // === BIND EVENTS ===
    document.addEventListener('DOMContentLoaded', async () => {
      document.body.classList.add('blurred');
      el('loginOverlay').classList.add('show');

      supabase.auth.onAuthStateChange(async (_evt, session) => {
        if (!session?.user){
          document.body.classList.add('blurred'); el('loginOverlay').classList.add('show'); return;
        }
        el('loginOverlay').classList.remove('show'); document.body.classList.remove('blurred');
        await applyRoleAndGudang();
        await renderRiwayat();
        await updateTotal();
      });

      // LOGIN
      el('loginBtn').onclick = async () => {
        try {
          let loginId = el('loginUser').value.trim();
          // opsional: dukung username tanpa '@'
          // if (!loginId.includes('@')) loginId = `${loginId}@pkbbatam.local`;
          await signIn(loginId, el('loginPass').value);
        } catch(e){
          alert('Login gagal: ' + (e?.message||e)); console.error(e);
        }
      };
      el('loginPass').addEventListener('keydown', (e)=>{ if(e.key==='Enter') el('loginBtn').click(); });
      el('loginClose').onclick = ()=>{}; // jangan ditutup

      // LOGOUT
      el('btnLogout').onclick = async () => { await signOut(); };

      // INPUT
      el('gudang').addEventListener('change', updateTotal);

      // TUNJUK
      el('btnTunjuk').onclick = async () => {
        const nom = el('nomor').value.trim();
        const jen = el('jenis').value; const gud = el('gudang').value;
        if(!/^\d+$/.test(nom)) return alert('Nomor hanya boleh angka');
        if(!jen || !gud) return alert('Lengkapi form');
        try {
          const { data: exist, error: e1 } = await supabase.from('penunjukan_history').select('id').eq('nomor', nom).eq('jenis', jen).limit(1);
          if (e1) throw e1;
          if (exist && exist.length) return alert('Penunjukan untuk nomor & jenis ini sudah ada');

          const nama = await pickNama(gud);
          await addHistory({ nomor: nom, jenis: jen, gudang: gud, pemeriksa: nama });
          alert(`Berhasil menugaskan: ${nama}`);
          await updateTotal();
          await renderRiwayat();
        } catch(e){ alert('Gagal menugaskan: ' + (e?.message||e)); console.error(e); }
      };

      // BROWSE
      const browseOv = el('browseOverlay');
      el('btnBrowseHeader').onclick = ()=> browseOv.classList.add('show');
      el('browseClose').onclick = ()=> browseOv.classList.remove('show');
      browseOv.onclick = (e)=>{ if(e.target===browseOv) browseOv.classList.remove('show'); };
      el('btnBrowseModal').onclick = async ()=>{
        const nom = el('browseNomor').value.trim();
        const rows = await listHistory({ nomor: nom || undefined });
        const body = document.querySelector('#browseResults tbody');
        body.innerHTML = rows.length ? rows.map((r,i)=>`
          <tr>
            <td>${i+1}</td><td>${r.nomor}</td><td>${r.jenis}</td>
            <td>${r.gudang}</td><td>${new Date(r.tanggal).toLocaleDateString('id-ID')}</td>
            <td>${r.pemeriksa}</td><td>${(r.created_by||'').toString().slice(0,8)}</td>
          </tr>`).join('') : '<tr><td colspan="7">Tidak ada data</td></tr>';
      };

      // ADMIN
      const adminOv = el('adminOverlay');
      el('btnAdminHeader').onclick = async ()=>{
        const user = await me(); if(!user) return alert('Silakan login');
        const { data: prof } = await supabase.from('profiles').select('role').eq('id', user.id).single();
        if (prof?.role !== 'admin') return alert('Hanya admin');
        await renderAdmin(); adminOv.classList.add('show');
      };
      el('btnCloseAdmin').onclick = ()=> adminOv.classList.remove('show');
      adminOv.onclick = (e)=>{ if(e.target===adminOv) adminOv.classList.remove('show'); };

      async function renderAdmin(){
        const list = await supabase.from('pemeriksa').select('*').order('nama');
        const rows = list.data||[];
        el('adminBody').innerHTML = rows.map(p=>`
          <tr data-id="${p.id}">
            <td>${p.nama}</td>
            <td>
              <select class="selGudang">${['',...gudangList].map(g=>`<option ${g===p.gudang?'selected':''}>${g||'-- Pilih --'}</option>`).join('')}</select>
            </td>
            <td>
              <input type="checkbox" class="chkDel" /> Hapus
            </td>
          </tr>`).join('');
        el('adminTotal').innerText = rows.length;
        el('newGudang').innerHTML = '<option value="">-- Pilih --</option>' + gudangList.map(g=>`<option>${g}</option>`).join('');
      }

      el('adminGudangPreview').onchange = async function(){
        const g = this.value; const out = el('adminNext');
        if(!g){ out.innerText='-'; return; }
        const { data: pool } = await supabase.from('pools').select('remaining').eq('gudang', g).single();
        let candidates = (pool?.remaining?.length ? pool.remaining.slice() : (await listPemeriksa(g)).map(p=>p.nama));
        if (!candidates.length){ out.innerText = '-'; return; }
        const cand = candidates[Math.floor(Math.random()*candidates.length)];
        try { await setPreview(g, cand); out.innerText = cand; }
        catch(e){ alert(e.message||'Gagal set preview'); }
      };

      el('btnAdd').onclick = async ()=>{
        const nm = el('newNama').value.trim(); const gd = el('newGudang').value;
        if(!nm || !gd) return alert('Isi nama & gudang');
        try { await addPemeriksa(nm, gd); await renderAdmin(); alert('Ditambahkan'); }
        catch(e){ alert(e.message||'Gagal tambah'); }
      };
      el('btnUpd').onclick = async ()=>{
        const rows = [...document.querySelectorAll('#adminBody tr')];
        try {
          await Promise.all(rows.map(async tr => {
            const id = +tr.dataset.id; const gd = tr.querySelector('.selGudang').value;
            await updPemeriksa(id, gd);
          }));
          alert('Perubahan disimpan');
        } catch(e){ alert(e.message||'Gagal update'); }
      };
      el('btnDelSel').onclick = async ()=>{
        if(!confirm('Hapus baris yang dicentang?')) return;
        const rows = [...document.querySelectorAll('#adminBody tr')];
        try {
          await Promise.all(rows.filter(tr=>tr.querySelector('.chkDel').checked).map(async tr => {
            await delPemeriksa(+tr.dataset.id);
          }));
          await renderAdmin();
        } catch(e){ alert(e.message||'Gagal hapus'); }
      };

      el('btnClearHist').onclick = async ()=>{
        if(!confirm('Hapus seluruh riwayat?')) return;
        try { await supabase.from('penunjukan_history').delete().neq('id', -1); await renderRiwayat(); alert('Riwayat dibersihkan'); }
        catch(e){ alert(e.message||'Gagal hapus riwayat'); }
      };
      el('btnResetPool').onclick = async ()=>{
        if(!confirm('Reset semua pool & preview?')) return;
        try {
          await supabase.from('pools').delete().neq('gudang','');
          await supabase.from('preview_pick').delete().neq('gudang','');
          await updateTotal();
          alert('Pool & preview direset');
        } catch(e){ alert(e.message||'Gagal reset'); }
      };

      // SETTINGS (User & Roles)
      const setOv = el('settingsOverlay');
      const setBtn = el('btnSettingsHeader');
      const setClose = el('settingsClose');
      const userTableEl = document.getElementById('userTable');
      const userTableBody = userTableEl.querySelector('tbody');
      const userRoles = document.getElementById('userRoles');
      const userNameIn = document.getElementById('userName');
      const saveUser = document.getElementById('btnSaveUser');
      const cancelUser = document.getElementById('btnCancelUser');

      let usersCache = [];
      let rolesMap = {};   // user_id -> [gudang]
      let editingUserId = null;

      function fillGudangOptions(){
        userRoles.innerHTML = gudangList.map(g=>`<option value="${g}">${g}</option>`).join('');
      }

      async function loadUsersAndRoles(){
        const { data: users, error: e1 } = await supabase.from('profiles').select('id, username, role').order('username');
        if(e1) throw e1;
        usersCache = users || [];

        const { data: rbg, error: e2 } = await supabase.from('roles_by_gudang').select('user_id, gudang');
        if(e2) throw e2;

        rolesMap = {};
        (rbg||[]).forEach(r => {
          if(!rolesMap[r.user_id]) rolesMap[r.user_id] = [];
          rolesMap[r.user_id].push(r.gudang);
        });
      }

      function renderUserTable(){
        userTableBody.innerHTML = (usersCache||[]).map(u => `
          <tr data-id="${u.id}">
            <td>${u.username||'(tanpa email)'}</td>
            <td>${u.role}</td>
            <td>${(rolesMap[u.id]||[]).join(', ')}</td>
            <td>
              <button class="btn secondary btnEdit" data-id="${u.id}">Edit</button>
              <button class="btn danger btnClear" data-id="${u.id}">Kosongkan Gudang</button>
            </td>
          </tr>
        `).join('');
      }

      setBtn.onclick = async ()=>{
        const user = await me(); if(!user) return alert('Silakan login');
        const { data: prof } = await supabase.from('profiles').select('role').eq('id', user.id).single();
        if (prof?.role !== 'admin') return alert('Hanya admin');

        setOv.classList.add('show');
        fillGudangOptions();
        try {
          await loadUsersAndRoles();
          renderUserTable();
        } catch(e){ alert(e.message||'Gagal load users'); }
      };

      setClose.onclick = ()=> setOv.classList.remove('show');
      setOv.onclick    = e=>{ if(e.target===setOv) setOv.classList.remove('show'); };

      // Delegasi klik pada tabel (Edit / Kosongkan)
      userTableEl.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button'); if(!btn) return;
        const id = btn.dataset.id; if(!id) return;

        if(btn.classList.contains('btnEdit')){
          editingUserId = id;
          const u = usersCache.find(x=>x.id===id);
          userNameIn.value = u?.username||'(tanpa email)';
          const allowed = rolesMap[id]||[];
          Array.from(userRoles.options).forEach(opt => { opt.selected = allowed.includes(opt.value); });
          return;
        }

        if(btn.classList.contains('btnClear')){
          if(!confirm('Kosongkan semua akses gudang user ini?')) return;
          const { error } = await supabase.from('roles_by_gudang').delete().eq('user_id', id);
          if(error){ alert(error.message); return; }
          await loadUsersAndRoles(); renderUserTable();
          if(editingUserId===id){ Array.from(userRoles.options).forEach(o=>o.selected=false); }
          return;
        }
      });

      saveUser.onclick = async ()=>{
        if(!editingUserId) return alert('Klik tombol Edit pada salah satu user dulu.');
        const selected = Array.from(userRoles.selectedOptions).map(o=>o.value);
        try{
          const del = await supabase.from('roles_by_gudang').delete().eq('user_id', editingUserId);
          if(del.error) throw del.error;
          if(selected.length){
            const ins = await supabase.from('roles_by_gudang').insert(selected.map(g=>({ user_id: editingUserId, gudang: g })));
            if(ins.error) throw ins.error;
          }
          await loadUsersAndRoles(); renderUserTable();
          alert('Akses gudang disimpan.');
        }catch(e){ alert(e.message||'Gagal simpan'); }
      };

      cancelUser.onclick = ()=>{
        editingUserId = null;
        userNameIn.value = '';
        Array.from(userRoles.options).forEach(o=>o.selected=false);
      };
    });
  </script>
</body>
</html>

